#!/bin/bash

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ Criage
# –°–æ–±–∏—Ä–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç –∏ repository —Å–µ—Ä–≤–µ—Ä —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π

set -e

echo "üèóÔ∏è  –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Criage —Å –ø–æ–º–æ—â—å—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
echo "======================================================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏
print_time() {
    echo "‚è∞ $(date '+%H:%M:%S'): $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
check_success() {
    if [ $? -eq 0 ]; then
        echo "‚úÖ $1 - —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ùå $1 - –æ—à–∏–±–∫–∞!"
        exit 1
    fi
}

print_time "–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
echo "üì¶ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞..."
if [ ! -f "./criage" ]; then
    print_time "–°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
    go build -o criage .
    check_success "–°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
else
    echo "‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# 2. –°–±–æ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
echo ""
echo "üñ•Ô∏è  –≠—Ç–∞–ø 2: –°–±–æ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π..."
print_time "–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞:"
echo "  ‚Ä¢ –ò–º—è: criage"
echo "  ‚Ä¢ –í–µ—Ä—Å–∏—è: 1.0.0"
echo "  ‚Ä¢ –¢–∏–ø: –ü–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å embedded –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π"

./criage build -o criage-client-embedded.tar.zst -f tar.zst -c 6
check_success "–°–±–æ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞"

if [ -f "criage-client-embedded.tar.zst" ]; then
    client_size=$(du -h criage-client-embedded.tar.zst | cut -f1)
    echo "üìè –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞: $client_size"
fi

# 3. –°–±–æ—Ä–∫–∞ repository —Å–µ—Ä–≤–µ—Ä–∞
echo ""
echo "üåê –≠—Ç–∞–ø 3: –°–±–æ—Ä–∫–∞ repository —Å–µ—Ä–≤–µ—Ä–∞ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π..."
print_time "–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ repository"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é repository
cd repository

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ repository
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ repository:"
echo "  ‚Ä¢ –ò–º—è: criage-repository"
echo "  ‚Ä¢ –í–µ—Ä—Å–∏—è: 1.0.0"
echo "  ‚Ä¢ –¢–∏–ø: Repository —Å–µ—Ä–≤–µ—Ä —Å embedded –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π"

../criage build -o criage-repository-embedded.tar.zst -f tar.zst -c 6
check_success "–°–±–æ—Ä–∫–∞ repository —Å–µ—Ä–≤–µ—Ä–∞"

if [ -f "criage-repository-embedded.tar.zst" ]; then
    repo_size=$(du -h criage-repository-embedded.tar.zst | cut -f1)
    echo "üìè –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ repository: $repo_size"
fi

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

# 4. –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo ""
echo "üéâ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
echo "======================================================================"
print_time "–ö–æ–Ω–µ—Ü —Å–±–æ—Ä–∫–∏"

echo ""
echo "üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã:"
if [ -f "criage-client-embedded.tar.zst" ]; then
    client_size=$(du -h criage-client-embedded.tar.zst | cut -f1)
    echo "  ‚Ä¢ criage-client-embedded.tar.zst ($client_size)"
fi

if [ -f "repository/criage-repository-embedded.tar.zst" ]; then
    repo_size=$(du -h repository/criage-repository-embedded.tar.zst | cut -f1)
    echo "  ‚Ä¢ repository/criage-repository-embedded.tar.zst ($repo_size)"
fi

echo ""
echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:"
echo "  ‚Ä¢ –ö–ª–∏–µ–Ω—Ç: –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä"
echo "  ‚Ä¢ –°–µ—Ä–≤–µ—Ä: —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º"
echo "  ‚Ä¢ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –æ–±–∞ –∞—Ä—Ö–∏–≤–∞ (ru, en, de, es)"
echo ""
echo "üí° –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  ./criage metadata criage-client-embedded.tar.zst"
echo "  ./criage metadata repository/criage-repository-embedded.tar.zst" 